{
  "action": "created",
  "issue": {
    "url": "https://api.github.com/repos/Alamofire/Alamofire/issues/206",
    "repository_url": "https://api.github.com/repos/Alamofire/Alamofire",
    "labels_url": "https://api.github.com/repos/Alamofire/Alamofire/issues/206/labels{/name}",
    "comments_url": "https://api.github.com/repos/Alamofire/Alamofire/issues/206/comments",
    "events_url": "https://api.github.com/repos/Alamofire/Alamofire/issues/206/events",
    "html_url": "https://github.com/Alamofire/Alamofire/issues/206",
    "id": 47809604,
    "number": 206,
    "title": "escape function crashes when escaping long Chinese strings",
    "user": {
      "login": "PrideChung",
      "id": 1381489,
      "avatar_url": "https://avatars2.githubusercontent.com/u/1381489?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PrideChung",
      "html_url": "https://github.com/PrideChung",
      "followers_url": "https://api.github.com/users/PrideChung/followers",
      "following_url": "https://api.github.com/users/PrideChung/following{/other_user}",
      "gists_url": "https://api.github.com/users/PrideChung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PrideChung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PrideChung/subscriptions",
      "organizations_url": "https://api.github.com/users/PrideChung/orgs",
      "repos_url": "https://api.github.com/users/PrideChung/repos",
      "events_url": "https://api.github.com/users/PrideChung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PrideChung/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
               {
               "id": 118362600,
               "url": "https://api.github.com/repos/Alamofire/Alamofire/labels/bug",
               "name": "bug",
               "color": "ff3333",
               "default": true
               },
               {
               "id": 207127326,
               "url": "https://api.github.com/repos/Alamofire/Alamofire/labels/parameter%20encoding",
               "name": "parameter encoding",
               "color": "69B805",
               "default": false
               }
               ],
    "state": "closed",
    "locked": false,
    "assignee": {
      "login": "cnoon",
      "id": 169110,
      "avatar_url": "https://avatars2.githubusercontent.com/u/169110?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cnoon",
      "html_url": "https://github.com/cnoon",
      "followers_url": "https://api.github.com/users/cnoon/followers",
      "following_url": "https://api.github.com/users/cnoon/following{/other_user}",
      "gists_url": "https://api.github.com/users/cnoon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cnoon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cnoon/subscriptions",
      "organizations_url": "https://api.github.com/users/cnoon/orgs",
      "repos_url": "https://api.github.com/users/cnoon/repos",
      "events_url": "https://api.github.com/users/cnoon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cnoon/received_events",
      "type": "User",
      "site_admin": false
    },
    "assignees": [
                  {
                  "login": "cnoon",
                  "id": 169110,
                  "avatar_url": "https://avatars2.githubusercontent.com/u/169110?v=3",
                  "gravatar_id": "",
                  "url": "https://api.github.com/users/cnoon",
                  "html_url": "https://github.com/cnoon",
                  "followers_url": "https://api.github.com/users/cnoon/followers",
                  "following_url": "https://api.github.com/users/cnoon/following{/other_user}",
                  "gists_url": "https://api.github.com/users/cnoon/gists{/gist_id}",
                  "starred_url": "https://api.github.com/users/cnoon/starred{/owner}{/repo}",
                  "subscriptions_url": "https://api.github.com/users/cnoon/subscriptions",
                  "organizations_url": "https://api.github.com/users/cnoon/orgs",
                  "repos_url": "https://api.github.com/users/cnoon/repos",
                  "events_url": "https://api.github.com/users/cnoon/events{/privacy}",
                  "received_events_url": "https://api.github.com/users/cnoon/received_events",
                  "type": "User",
                  "site_admin": false
                  }
                  ],
    "milestone": {
      "url": "https://api.github.com/repos/Alamofire/Alamofire/milestones/13",
      "html_url": "https://github.com/Alamofire/Alamofire/milestone/13",
      "labels_url": "https://api.github.com/repos/Alamofire/Alamofire/milestones/13/labels",
      "id": 1315501,
      "number": 13,
      "title": "2.0.2",
      "description": "Bug fixes",
      "creator": {
        "login": "cnoon",
        "id": 169110,
        "avatar_url": "https://avatars2.githubusercontent.com/u/169110?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/cnoon",
        "html_url": "https://github.com/cnoon",
        "followers_url": "https://api.github.com/users/cnoon/followers",
        "following_url": "https://api.github.com/users/cnoon/following{/other_user}",
        "gists_url": "https://api.github.com/users/cnoon/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/cnoon/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cnoon/subscriptions",
        "organizations_url": "https://api.github.com/users/cnoon/orgs",
        "repos_url": "https://api.github.com/users/cnoon/repos",
        "events_url": "https://api.github.com/users/cnoon/events{/privacy}",
        "received_events_url": "https://api.github.com/users/cnoon/received_events",
        "type": "User",
        "site_admin": false
      },
      "open_issues": 0,
      "closed_issues": 3,
      "state": "closed",
      "created_at": "2015-09-20T23:20:38Z",
      "updated_at": "2015-09-22T03:27:51Z",
      "due_on": "2015-09-20T07:00:00Z",
      "closed_at": "2015-09-22T03:27:51Z"
    },
    "comments": 7,
    "created_at": "2014-11-05T08:07:24Z",
    "updated_at": "2017-03-20T19:36:20Z",
    "closed_at": "2014-11-06T05:08:40Z",
    "body": "This problem would be easier to reproduce on iOS devices with smaller RAM, I first found it on an iPod Touch 5 with 512MB RAM. It crashes everytime when I try to encode a POST parameter with more than 500 Chinese characters, and it only gives me an EXC_BAD_ACCESS with no further information. On iPhone 5 with 1GB RAM it can handle about 1300 Chinese characters but still crash if the limitation is exceeded. \n\nFor quick reference, this is the `escape` function I copied from `Alamofire.swift` line 154\n\n``` swift\nfunc escape(string: String) -> String {\n    let allowedCharacters =  NSCharacterSet(charactersInString:\" =\\\"#%/<>?@\\\\^`{}[]|&+\").invertedSet\n    return string.stringByAddingPercentEncodingWithAllowedCharacters(allowedCharacters) ?? string\n}\n```\n\nI can almost sure the reason of the crash is `stringByAddingPercentEncodingWithAllowedCharacters` takes too much memory, this is particularly obvious when it's encoding Chinese or Japanese strings, maybe because the encoding process is more complex for these languages.\n\nI discovered that if I slice the long string into small pieces and call `stringByAddingPercentEncodingWithAllowedCharacters` in batches like below will fix the memory peak problem, \n\n``` swift\nfunc escape(string: String) -> String {\n    let allowedCharacters =  NSCharacterSet(charactersInString:\" =\\\"#%/<>?@\\\\^`{}[]|&+\").invertedSet\n    let batchSize = 100\n    var escapedString = \"\"\n    let stringLength = countElements(string)\n    for var i = 0; i < stringLength; i += batchSize {\n        let rangeLength = i + batchSize > stringLength ? stringLength - i : batchSize;\n        let slicedString = (string as NSString).substringWithRange(NSMakeRange(i, rangeLength))\n        escapedString += slicedString.stringByAddingPercentEncodingWithAllowedCharacters(allowedCharacters) ?? slicedString\n    }\n    return escapedString\n}\n```\n\nI don't even need to place `autoreleasepool` between each for loops, I suspect there is already a autoreleasepool inside the implementation of `stringByAddingPercentEncodingWithAllowedCharacters`\n\nThen I was wondering why I've never encountered this issue in AFNetworking, so I read the source code of `AFURLRequestSerialization`. Turns out `stringByAddingPercentEncodingWithAllowedCharacters` is only available after iOS 7 and AFNetworking supports iOS 6 so it use the lower level API `CFURLCreateStringByAddingPercentEscapes` which does not suffering from this memory peak issue, or at least not so obvious.\n\nSo here're two possible solutions we have for now:\n1. Do it in batches\n2. Use the lower level API like AFNetworking does.\n\nAn  example project is provided to reproduce this problem: https://github.com/PrideChung/AlamofireEscapeCrashExample\n"
  },
  "comment": {
    "url": "https://api.github.com/repos/Alamofire/Alamofire/issues/comments/287873409",
    "html_url": "https://github.com/Alamofire/Alamofire/issues/206#issuecomment-287873409",
    "issue_url": "https://api.github.com/repos/Alamofire/Alamofire/issues/206",
    "id": 287873409,
    "user": {
      "login": "jshier",
      "id": 51020,
      "avatar_url": "https://avatars3.githubusercontent.com/u/51020?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jshier",
      "html_url": "https://github.com/jshier",
      "followers_url": "https://api.github.com/users/jshier/followers",
      "following_url": "https://api.github.com/users/jshier/following{/other_user}",
      "gists_url": "https://api.github.com/users/jshier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jshier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jshier/subscriptions",
      "organizations_url": "https://api.github.com/users/jshier/orgs",
      "repos_url": "https://api.github.com/users/jshier/repos",
      "events_url": "https://api.github.com/users/jshier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jshier/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-03-20T19:36:19Z",
    "updated_at": "2017-03-20T19:36:19Z",
    "body": "It was only found to crash for iOS 8.1 and 8.2, hence our workaround only affects those OSes. There shouldn't be any further issue here. If you are seeing a new crash, please open a new issue."
  }
}
